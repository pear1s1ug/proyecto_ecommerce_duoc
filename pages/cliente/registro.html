<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro - Hazel Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../css/cliente-styles.css">
</head>
<body>
  <header class="p-3  d-flex justify-content-between align-items-center">
    <div id="logo">
      <a href="../../index.html" class="text-white font-weight-bold" style="font-size: 1.2rem; text-decoration: none;">
        Hazelüå∞Lab
      </a>
    </div>
  </header>

  <main class="container my-5">
    <div class="col-md-6 mx-auto">
      <h1 class="text-center mb-4">Registro de Usuario</h1>

      <form id="form-registro" class="border p-4 rounded bg-light shadow-sm">
        <!-- RUN -->
        <div class="form-group">
          <label for="run">RUN</label>
          <input id="run" name="run" type="text" class="form-control" required minlength="7" maxlength="9" placeholder="Ej: 19011022K">
        </div>

        <!-- Nombre -->
        <div class="form-group">
          <label for="nombre">Nombre</label>
          <input id="nombre" name="nombre" type="text" class="form-control" required maxlength="50" placeholder="Ingrese su nombre">
        </div>

        <!-- Apellidos -->
        <div class="form-group">
          <label for="apellidos">Apellidos</label>
          <input id="apellidos" name="apellidos" type="text" class="form-control" required maxlength="100" placeholder="Ingrese sus apellidos">
        </div>

        <!-- Correo -->
        <div class="form-group">
          <label for="correo">Correo</label>
          <input id="correo" name="correo" type="email" class="form-control" required maxlength="100" placeholder="usuario@dominio.com">
        </div>

        <!-- Fecha de nacimiento (opcional) -->
        <div class="form-group">
          <label for="fechaNacimiento">Fecha de Nacimiento (opcional)</label>
          <input id="fechaNacimiento" name="fechaNacimiento" type="date" class="form-control">
        </div>

        <!-- Regi√≥n -->
        <div class="form-group">
          <label for="region">Regi√≥n</label>
          <select id="region" name="region" class="form-control" required></select>
        </div>

        <!-- Comuna -->
        <div class="form-group">
          <label for="comuna">Comuna</label>
          <select id="comuna" name="comuna" class="form-control" required></select>
        </div>

        <!-- Direcci√≥n -->
        <div class="form-group">
          <label for="direccion">Direcci√≥n</label>
          <textarea id="direccion" name="direccion" class="form-control" required maxlength="300" placeholder="Ingrese su direcci√≥n"></textarea>
        </div>

        <!-- Contrase√±a -->
        <div class="form-group">
          <label for="clave">Contrase√±a</label>
          <input id="clave" name="clave" type="password" class="form-control" required minlength="4" maxlength="10" placeholder="Ingrese una contrase√±a">
        </div>

        <!-- Confirmar Contrase√±a -->
        <div class="form-group">
          <label for="confirmarClave">Confirmar Contrase√±a</label>
          <input id="confirmarClave" name="confirmarClave" type="password" class="form-control" required minlength="4" maxlength="10" placeholder="Repita su contrase√±a">
        </div>

        <!-- Botones principales -->
        <div class="d-flex justify-content-between mt-4">
          <button type="submit" class="btn btn-primary">Crear Cuenta</button>
        </div>

        <!-- Botones de navegaci√≥n -->
        <div class="d-flex justify-content-between mt-3">
          <a href="../../index.html" class="btn btn-secondary">‚Üê Volver al Home</a>
          <a href="login.html" class="btn btn-link">Ir a Iniciar Sesi√≥n ‚Üí</a>
        </div>
      </form>
    </div>
  </main>

  <footer class=" text-center py-3 mt-5">
    <p>¬© 2025 DUOC - Hazel Lab</p>
  </footer>

  <script src="../../js/admin-scripts.js"></script>
  <script>
    // Cargar regiones y comunas
    console.log("Cargando regiones y comunas...");
    llenarRegionesYComunas("region", "comuna");

    // Validaciones
    function validarRun(run) {
      return /^[0-9]{7,8}[0-9Kk]{1}$/.test(run);
    }
    
    function validarCorreo(correo) {
      return /^[a-zA-Z0-9._%+-]+@(duoc\.cl|profesor\.duoc\.cl|gmail\.com)$/.test(correo);
    }

    // CORRECCI√ìN CR√çTICA: Usar "clientes" en lugar de "usuarios"
    function obtenerUsuarios() {
      const clientes = JSON.parse(localStorage.getItem("clientes")) || [];
      console.log("Usuarios obtenidos de 'clientes':", clientes);
      return clientes;
    }
    
    function guardarUsuarios(usuarios) {
      console.log("Guardando usuarios en 'clientes':", usuarios);
      localStorage.setItem("clientes", JSON.stringify(usuarios));
    }

    document.getElementById("form-registro").addEventListener("submit", function(e) {
      e.preventDefault();

      const run = document.getElementById("run").value.trim();
      const nombre = document.getElementById("nombre").value.trim();
      const apellidos = document.getElementById("apellidos").value.trim();
      const correo = document.getElementById("correo").value.trim();
      const fechaNacimiento = document.getElementById("fechaNacimiento").value;
      const region = document.getElementById("region").value;
      const comuna = document.getElementById("comuna").value;
      const direccion = document.getElementById("direccion").value.trim();
      const clave = document.getElementById("clave").value.trim();
      const confirmarClave = document.getElementById("confirmarClave").value.trim();

      console.log("Datos del formulario:", {
        run, nombre, apellidos, correo, region, comuna, direccion, clave
      });

      // Validaciones
      if (!validarRun(run)) {
        alert("RUN inv√°lido. Debe ir sin puntos ni guion, ej: 19011022K");
        return;
      }
      
      if (!validarCorreo(correo)) {
        alert("Correo inv√°lido. Solo se permiten @duoc.cl, @profesor.duoc.cl o @gmail.com");
        return;
      }
      
      if (!clave) {
        alert("La contrase√±a es obligatoria");
        return;
      }
      
      if (clave.length < 4 || clave.length > 10) {
        alert("La contrase√±a debe tener entre 4 y 10 caracteres");
        return;
      }
      
      if (clave !== confirmarClave) {
        alert("Las contrase√±as no coinciden");
        return;
      }

      let usuarios = obtenerUsuarios();
      console.log("Usuarios actuales:", usuarios);

      // CORRECCI√ìN: Verificar si el RUN ya existe (con validaci√≥n segura)
      if (usuarios.some(u => u && u.id === run)) {
        alert("El RUN ya est√° registrado");
        return;
      }

      // CORRECCI√ìN: Verificar si el CORREO ya existe
      if (usuarios.some(u => u && (u.correo === correo || u.email === correo))) {
        alert("El correo electr√≥nico ya est√° registrado");
        return;
      }

      const nuevoUsuario = {
        id: run,
        nombre,
        apellidos,
        correo, // Siempre usar 'correo' para nueva estructura
        fechaNacimiento,
        tipoUsuario: "Cliente",
        region,
        comuna,
        direccion,
        clave
      };

      console.log("Nuevo usuario a guardar:", nuevoUsuario);

      usuarios.push(nuevoUsuario);
      guardarUsuarios(usuarios);

      // Verificar que se guard√≥ correctamente
      const usuariosDespues = JSON.parse(localStorage.getItem("clientes")) || [];
      console.log("Usuarios despu√©s del registro:", usuariosDespues);

      alert("‚úÖ Usuario registrado correctamente!\n\nAhora puedes iniciar sesi√≥n con:\nCorreo: " + correo + "\nContrase√±a: " + clave);
      
      window.location.href = "login.html";
    });

    // Debug al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      console.log("=== DEBUG REGISTRO ===");
      console.log("Clientes en localStorage:", JSON.parse(localStorage.getItem("clientes")));
      console.log("Usuarios en localStorage:", JSON.parse(localStorage.getItem("usuarios")));
      console.log("Funci√≥n llenarRegionesYComunas existe:", typeof llenarRegionesYComunas);
    });
  </script>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>