<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Nuevo Producto</title>
  <link rel="stylesheet" href="../../css/admin-styles.css">
</head>
<body>
  <div id="container">
    <!-- Sidebar -->
    <aside id="menu-sidebar">
      <div id="logo">Hazel游꺓Lab</div>
      <nav id="menu">
        <ul>
          <li><a href="menu-admin.html" class="active">Dashboard</a></li>
          <li><a href="vista-clientes.html">Ver Clientes</a></li>
          <li><a href="vista-productos.html">Ver Inventario</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main -->
    <main id="main">
      <header id="header">
        <h2>Nuevo Producto</h2>
      </header>

      <section id="form-section">
        <form id="nuevoProductoForm">
          <fieldset>
            <legend>Registro de producto</legend>

            <label for="codigo">C칩digo Producto *</label>
            <input type="text" id="codigo" name="codigo" required minlength="3" placeholder="PST-001">

            <label for="lote">C칩digo Lote *</label>
            <input type="text" id="lote" name="lote" required minlength="3" placeholder="LOT-PST-001">

            <label for="nombre">Nombre *</label>
            <input type="text" id="nombre" name="nombre" required maxlength="100">

            <label for="descripcion">Descripci칩n</label>
            <textarea id="descripcion" name="descripcion" maxlength="500" rows="3"></textarea>

            <label for="precio">Precio *</label>
            <input type="number" id="precio" name="precio" required min="0" step="0.01">

            <label for="stock">Stock *</label>
            <input type="number" id="stock" name="stock" required min="0">

            <label for="stockCritico">Stock Cr칤tico</label>
            <input type="number" id="stockCritico" name="stockCritico" min="0">

            <label for="categoria">Categor칤a *</label>
            <select id="categoria" name="categoria" required></select>

            <label for="fechaElaboracion">Fecha de Elaboraci칩n *</label>
            <input type="date" id="fechaElaboracion" name="fechaElaboracion" required>

            <label for="fechaVencimiento">Fecha de Vencimiento *</label>
            <input type="date" id="fechaVencimiento" name="fechaVencimiento" required>

            <label for="codigoQuimico">C칩digo Qu칤mico</label>
            <input type="text" id="codigoQuimico" name="codigoQuimico" maxlength="50">

            <label for="proveedor">Proveedor</label>
            <input type="text" id="proveedor" name="proveedor" maxlength="100">
          </fieldset>

          <div class="form-actions">
            <button type="submit">Registrar Producto</button>
          </div>
        </form>
      </section>
    </main>
  </div>

  <script src="../../js/admin-scripts.js"></script>
  <script>
    // Llenar select de categor칤as
    llenarCategorias("categoria");

    // Manejo del formulario de nuevo producto
    document.getElementById("nuevoProductoForm").addEventListener("submit", function(e){
      e.preventDefault();

      const codigo = document.getElementById("codigo").value.trim();
      const lote = document.getElementById("lote").value.trim();
      const nombre = document.getElementById("nombre").value.trim();
      const descripcion = document.getElementById("descripcion").value.trim();
      const precio = parseFloat(document.getElementById("precio").value);
      const stock = parseInt(document.getElementById("stock").value);
      const stockCritico = document.getElementById("stockCritico").value ? parseInt(document.getElementById("stockCritico").value) : null;
      const categoria = document.getElementById("categoria").value;
      const fechaElaboracion = document.getElementById("fechaElaboracion").value;
      const fechaVencimiento = document.getElementById("fechaVencimiento").value;
      const codigoQuimico = document.getElementById("codigoQuimico").value.trim();
      const proveedor = document.getElementById("proveedor").value.trim();

      // Validaciones
      if (!validarCodigoProducto(codigo)) {
        alert("C칩digo inv치lido. Debe tener al menos 3 caracteres.");
        return;
      }

      if (!validarLote(lote)) {
        alert("Lote inv치lido. Debe tener al menos 3 caracteres.");
        return;
      }

      if (!validarPrecio(precio)) {
        alert("Precio inv치lido. Debe ser mayor o igual a 0.");
        return;
      }

      if (!validarStock(stock)) {
        alert("Stock inv치lido. Debe ser un n칰mero entero mayor o igual a 0.");
        return;
      }

      if (stockCritico !== null && !validarStockCritico(stockCritico)) {
        alert("Stock cr칤tico inv치lido. Debe ser un n칰mero entero mayor o igual a 0.");
        return;
      }

      // Validar que fecha elaboraci칩n sea anterior a fecha vencimiento
      if (fechaElaboracion && fechaVencimiento && new Date(fechaElaboracion) > new Date(fechaVencimiento)) {
        alert("La fecha de elaboraci칩n no puede ser posterior a la fecha de vencimiento.");
        return;
      }

      const productos = obtenerProductos();
      
      // Verificar si el c칩digo ya existe
      if (productos.some(p => p.codigo === codigo)) {
        alert("El c칩digo de producto ya est치 registrado");
        return;
      }

      const nuevoProducto = {
        codigo: codigo,
        lote: lote,
        nombre: nombre,
        descripcion: descripcion || "",
        precio: precio,
        stock: stock,
        stockCritico: stockCritico,
        categoria: categoria,
        fechaElaboracion: fechaElaboracion,
        fechaVencimiento: fechaVencimiento,
        proveedor: proveedor || "",
        codigoQuimico: codigoQuimico || null
      };

      productos.push(nuevoProducto);
      guardarProductos(productos);
      alert("Producto registrado correctamente");
      window.location.href = "vista-productos.html?t=" + Date.now();
    });
  </script>
</body>
</html>